{"version":3,"file":"elo-store.js","sourceRoot":"","sources":["../../src/elo-store.ts"],"names":[],"mappings":"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","sourcesContent":["import { AgentPubKeyB64, serializeHash } from '@holochain-open-dev/core-types';\nimport { HoloHashed } from '@holochain/conductor-api';\nimport { derived, writable, Readable, Writable } from 'svelte/store';\nimport { EloService } from './elo-service';\nimport { GameResult } from './types';\nimport { headerTimestamp } from './utils';\n\nexport enum ShortResult {\n  Win = 1.0,\n  Loss = 0.0,\n  Draw = 0.5,\n}\n\nexport class EloStore {\n  #gameResults: Writable<{\n    [key: AgentPubKeyB64]: Array<[HoloHashed<any>, GameResult]>;\n  }> = writable({});\n  #elos: Writable<{\n    [key: AgentPubKeyB64]: number;\n  }> = writable({});\n\n  public elos = derived(this.#elos, i => i);\n  public eloRanking = derived(this.#elos, i =>\n    Object.entries(i)\n      .map(([agentPubKey, elo]) => ({ agentPubKey, elo }))\n      .sort((a, b) => b.elo - a.elo)\n  );\n\n  public gameResults = derived(this.#gameResults, i => i);\n\n  public myElo = derived(this.#elos, i => i[this.myAgentPubKey]);\n\n  public myGameResults = derived(this.#gameResults, i =>\n    i[this.myAgentPubKey].sort(\n      (\n        gr1,\n        gr2 // TODO: fix this\n      ) => headerTimestamp(gr2[0]) - headerTimestamp(gr1[0])\n    )\n  );\n\n  public get myAgentPubKey() {\n    return serializeHash(this.eloService.cellClient.cellId[1]);\n  }\n\n  constructor(protected eloService: EloService) {\n    // TODO: remove when scheduler actually works\n    setInterval(() => this.eloService.resolveFlags(), 5000);\n    this.eloService.resolveFlags();\n  }\n\n  /** Helpers for the types */\n\n  getOpponent(gameResult: GameResult): AgentPubKeyB64 {\n    if (gameResult.player_a.player_address === this.myAgentPubKey)\n      return gameResult.player_b.player_address;\n    else return gameResult.player_a.player_address;\n  }\n\n  getMyResult(gameResult: GameResult): number {\n    if (gameResult.player_a.player_address) return gameResult.score_player_a;\n    else return 1 - gameResult.score_player_a;\n  }\n\n  /** Backend actions */\n\n  async fetchMyGameResults() {\n    return this.fetchElosForAgents([this.myAgentPubKey]);\n  }\n\n  async fetchMyElo() {\n    return this.fetchGameResultsForAgents([this.myAgentPubKey]);\n  }\n\n  async fetchGameResultsForAgents(agents: AgentPubKeyB64[]): Promise<void> {\n    const gameResults = await this.eloService.getGameResultsForAgents(agents);\n\n    this.#gameResults.update(r => ({ ...r, ...gameResults }));\n  }\n\n  async fetchElosForAgents(agents: AgentPubKeyB64[]): Promise<void> {\n    const elos = await this.eloService.getEloRatingsForAgents(agents);\n    this.#elos.update(e => ({ ...e, ...elos }));\n  }\n}\n"]}