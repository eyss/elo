{"version":3,"file":"ranking-store.js","sourceRoot":"","sources":["../../src/state/ranking-store.ts"],"names":[],"mappings":";;AACA,OAAO,EACL,GAAG,EAKH,QAAQ,GACT,MAAM,cAAc,CAAC;AAYtB,MAAM,OAAO,eAAe;IAM1B,YACY,UAAsB,EACtB,aAA4B,EAC5B,SAAiB;QAFjB,eAAU,GAAV,UAAU,CAAY;QACtB,kBAAa,GAAb,aAAa,CAAe;QAC5B,cAAS,GAAT,SAAS,CAAQ;QAR7B,iCAAsC,QAAQ,CAAC;YAC7C,OAAO,EAAE,EAAE;YACX,yBAAyB,EAAE,IAAI;SAChC,CAAC,EAAC;IAMA,CAAC;IAEJ,SAAS,CAAC,UAAyC;QACjD,OAAO,uBAAA,IAAI,8BAAO,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;IAC3C,CAAC;IAED,KAAK,CAAC,cAAc;QAClB,MAAM,OAAO,GAAG,IAAI,CAAC,UAAU,EAAE,CAAC;QAElC,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,kBAAkB,CACxD,OAAO,EACP,IAAI,CAAC,SAAS,CACf,CAAC;QACF,IAAI,yBAAyB,GAAG,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,MAAM,KAAK,CAAC,CAAC;QAEpE,MAAM,cAAc,GAAqB,EAAE,CAAC;QAE5C,MAAM,KAAK,GAAe,EAAE,CAAC;QAE7B,KAAK,MAAM,CAAC,OAAO,EAAE,MAAM,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,SAAS,CAAC,EAAE;YACzD,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE;gBAC1B,IAAI,cAAc,CAAC,MAAM,GAAG,IAAI,CAAC,SAAS,EAAE;oBAC1C,cAAc,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;oBAC3B,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC;wBAAE,KAAK,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC;oBACzC,KAAK,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;iBAC5B;qBAAM;oBACL,yBAAyB,GAAG,IAAI,CAAC;iBAClC;aACF;SACF;QAED,MAAM,IAAI,CAAC,aAAa,CAAC,mBAAmB,CAAC,cAAc,CAAC,CAAC;QAE7D,uBAAA,IAAI,8BAAO,CAAC,MAAM,CAAC,CAAC,EAAE,OAAO,EAAE,EAAE,EAAE,CAAC,CAAC;YACnC,OAAO,EAAE;gBACP,GAAG,OAAO;gBACV,GAAG,KAAK;aACT;YACD,yBAAyB;SAC1B,CAAC,CAAC,CAAC;IACN,CAAC;IAEO,UAAU;QAChB,MAAM,OAAO,GAAG,GAAG,CAAC,uBAAA,IAAI,8BAAO,CAAC,CAAC,OAAO,CAAC;QAEzC,MAAM,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAChD,IAAI,IAAI,CAAC,MAAM,KAAK,CAAC;YAAE,OAAO,SAAS,CAAC;QAExC,OAAO,IAAI,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC;IAC/B,CAAC;CACF","sourcesContent":["import { ProfilesStore } from '@holochain-open-dev/profiles';\nimport {\n  get,\n  Readable,\n  Subscriber,\n  Unsubscriber,\n  Writable,\n  writable,\n} from 'svelte/store';\nimport flatten from 'lodash-es/flatten';\n\nimport { AgentPubKeyB64 } from '@holochain-open-dev/core-types';\nimport { EloService } from '../elo-service';\nimport { EloRanking } from '../types';\n\nexport interface ChunkedEloRanking {\n  ranking: EloRanking;\n  thereAreMoreChunksToFetch: boolean;\n}\n\nexport class EloRankingStore implements Readable<ChunkedEloRanking> {\n  #store: Writable<ChunkedEloRanking> = writable({\n    ranking: {},\n    thereAreMoreChunksToFetch: true,\n  });\n\n  constructor(\n    protected eloService: EloService,\n    protected profilesStore: ProfilesStore,\n    protected chunkSize: number\n  ) {}\n\n  subscribe(subscriber: Subscriber<ChunkedEloRanking>): Unsubscriber {\n    return this.#store.subscribe(subscriber);\n  }\n\n  async fetchNextChunk() {\n    const fromElo = this.newFromElo();\n\n    const nextChunk = await this.eloService.getEloRankingChunk(\n      fromElo,\n      this.chunkSize\n    );\n    let thereAreMoreChunksToFetch = Object.keys(nextChunk).length !== 0;\n\n    const pubKeysToFetch: AgentPubKeyB64[] = [];\n\n    const chunk: EloRanking = {};\n\n    for (const [ranking, agents] of Object.entries(nextChunk)) {\n      for (const agent of agents) {\n        if (pubKeysToFetch.length < this.chunkSize) {\n          pubKeysToFetch.push(agent);\n          if (!chunk[ranking]) chunk[ranking] = [];\n          chunk[ranking].push(agent);\n        } else {\n          thereAreMoreChunksToFetch = true;\n        }\n      }\n    }\n\n    await this.profilesStore.fetchAgentsProfiles(pubKeysToFetch);\n\n    this.#store.update(({ ranking }) => ({\n      ranking: {\n        ...ranking,\n        ...chunk,\n      },\n      thereAreMoreChunksToFetch,\n    }));\n  }\n\n  private newFromElo(): number | undefined {\n    const ranking = get(this.#store).ranking;\n\n    const elos = Object.keys(ranking).map(parseInt);\n    if (elos.length === 0) return undefined;\n\n    return Math.min(...elos) - 1;\n  }\n}\n"]}